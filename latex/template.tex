\documentclass[$if(fontsize)$$fontsize$,$endif$$if(lang)$$babel-lang$,$endif$$if(papersize)$$papersize$paper,$endif$$for(classoption)$$classoption$$sep$,$endfor$]{$documentclass$}

\usepackage{etoc} 
% 参考 ctexbook.cls 及
% http://www.latextemplates.com/template/the-legrand-orange-book
% https://tex.stackexchange.com/questions/48900/two-independent-tocs
\definecolor{ocre}{RGB}{243,102,25} % Define the orange color used for highlighting throughout the book

% 添加引言块
\def\VA#1#2{\addvspace{12pt}\raggedleft #1\rightskip3em\par #2\rightskip3em}
\renewenvironment{quote}
  {\list{}{\rightmargin\leftmargin}%
    \item\relax}
  {\endlist}

\makeatletter

\newif\ifusepartquote
\usepartquotetrue
\newcommand{\thepartquote}{}
\newcommand{\thepartquoteauthor}{}
\newcommand{\partquote}[2]{\ifusepartquote\renewcommand{\thepartquote}{#1}\renewcommand{\thepartquoteauthor}{#2}\fi}

\newif\ifusepartintro
\usepartintrotrue
\newcommand{\thepartintro}{}
\newcommand{\partintro}[1]{\ifusepartintro\renewcommand{\thepartintro}{#1}\fi}

% numbered part in the table of contents
\def\@part[#1]#2{%
  \ifnum \c@secnumdepth >-2\relax
    \ifodd \CTEX@part@numbering
      \CTEX@ifnametrue
      \refstepcounter{part}%
    \else
      \CTEX@ifnamefalse
      \CTEX@makeanchor{part*}%
    \fi
  \else
    \CTEX@ifnamefalse
    \CTEX@makeanchor{part*}%
  \fi
  \CTEX@addtocline{part}{#1}%
  \partmark{#1}%
  {\interlinepenalty \@M
   \normalfont \CTEX@part@format
   \ifnum \c@secnumdepth >-2\relax \ifodd \CTEX@part@numbering
     \CTEX@partname \CTEX@part@aftername
   \fi \fi}%
\markboth{}{}%
{\thispagestyle{empty}%
\begin{tikzpicture}[remember picture,overlay]%
\node at (current page.north west){\begin{tikzpicture}[remember picture,overlay]%	
\fill[ocre!20](0cm,0cm) rectangle (\paperwidth,-\paperheight);
\node[anchor=north] at (7cm,-3.25cm){\color{ocre!40}\fontsize{88}{40}\sffamily\bfseries\CTEX@partname};
\node[anchor=north east] at (\paperwidth-1cm,-9.25cm){\color{ocre!40}\fontsize{66}{30}\sffamily\bfseries\CTEX@part@titleformat{#2}};
\node[anchor=north west] at (2cm,-12.25cm){\ifusepartquote\parbox[t][][t]{\paperwidth-4cm}{\begin{quote}
`` \thepartquote ''

\VA{------ \thepartquoteauthor}{}
\end{quote}}\fi};
\node[anchor=north west] at (1cm,-16cm){\ifusepartintro\parbox[t][][t]{\paperwidth/2-1.5cm}{\quad\quad\thepartintro}\fi};
\node[anchor=north east] at (\paperwidth-1cm,-16cm){\parbox[t][][t]{\paperwidth/2-1.5cm}{
\etocsettocstyle{\renewcommand\contentsname{\null}}{}
\etocsetnexttocdepth{0} % 目录层次到章
\localtableofcontents
}};
\end{tikzpicture}};
\end{tikzpicture}}%
\@endpart}
\makeatother

$if(cover-image)$
\usepackage{wallpaper}
$endif$

\usepackage{booktabs}
\usepackage{longtable}
\usepackage{framed,color}
\definecolor{shadecolor}{RGB}{248,248,248}

\makeatletter
\newenvironment{kframe}{%
\medskip{}
\setlength{\fboxsep}{.8em}
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother
\newenvironment{Shaded}{\begin{kframe}}{\end{kframe}}

\makeatletter
\@ifundefined{Shaded}{
}{\renewenvironment{Shaded}{\begin{kframe}}{\end{kframe}}}
\makeatother
$for(bibliography)$
\addbibresource{$bibliography$}
$endfor$

\providecommand{\tightlist}{%
    \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

$if(href2footnote)$% 是否把链接改为脚注
\let\oldhref\href
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}
$endif$

\usepackage{listings}
% https://github.com/jgm/pandoc/issues/4716
% lstinline 对数学模式存在 bug，等修复后可以改为如下方式
% \newcommand{\passthrough}[1]{#1}
\newcommand{\passthrough}[1]{\lstset{mathescape=false}#1\lstset{mathescape=true}} 


% 感谢 AlexaraWu 的指导 https://github.com/sjtug/SJTUThesis/issues/343
% 兼容 Bookdown 定理等框架
% 重新定义定理环境
\usepackage{amsthm}
\makeatletter
\theoremstyle{plain}
  \newtheorem{theorem}{\sjtu@label@thm~}[chapter]
  \newtheorem{lemma}[theorem]{\sjtu@label@lem~}
  \newtheorem{proposition}[theorem]{\sjtu@label@prop~}
  \newtheorem{corollary}[theorem]{\sjtu@label@cor~}
\theoremstyle{definition}
  \newtheorem{definition}{\sjtu@label@defn~}[chapter]
  \newtheorem{exercise}{练习}[chapter]
  \newtheorem{conjecture}{\sjtu@label@conj~}[chapter]
  \newtheorem{example}{\sjtu@label@exmp~}[chapter]
\theoremstyle{remark}
  \newtheorem{remark}{\sjtu@label@rem~}
  \newtheorem*{solution}{\bfseries{解答}}
\makeatother

% https://tex.stackexchange.com/questions/154570/itemize-environment-within-a-tabular-environment/154577
% 添加各类消息框
\newenvironment{rmdblock}[1]
  {
  \begin{table}[!htpb]
  \begin{tabular}{|cc|}
  \hline \quad \quad \quad &
  \begin{minipage}{.88\textwidth}
  \begin{itemize}
  \renewcommand{\labelitemi}{
    \raisebox{-.7\height}[0pt][0pt]{
      {\setkeys{Gin}{width=3em,keepaspectratio}\includegraphics{figure/bookdown/#1}}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{kframe}
  \item
  }
  {
  \end{kframe}
  \end{itemize}
  \end{minipage}
  \\
  \hline
  \end{tabular}
  \end{table}
  }
\newenvironment{rmdnote}
  {\begin{rmdblock}{note}}
  {\end{rmdblock}}
\newenvironment{rmdcaution}
  {\begin{rmdblock}{caution}}
  {\end{rmdblock}}
\newenvironment{rmdimportant}
  {\begin{rmdblock}{important}}
  {\end{rmdblock}}
\newenvironment{rmdtip}
  {\begin{rmdblock}{tip}}
  {\end{rmdblock}}
\newenvironment{rmdwarning}
  {\begin{rmdblock}{warning}}
  {\end{rmdblock}}

% https://tex.stackexchange.com/questions/30312/shrink-figure-only-when-necessary
% 修复 Markdown 图片格式过大的问题。
\usepackage[export]{adjustbox}
\let\oldincludegraphics\includegraphics
\renewcommand\includegraphics[2][]{%
\begin{adjustbox}{max size={\textwidth}{\textheight}}
\oldincludegraphics[#1]{#2}
\end{adjustbox}
}

\begin{document}

$if(cover-image)$
  \cleardoublepage
  \thispagestyle{empty}
  \begin{center}
    \ThisTileWallPaper{\paperwidth}{\paperheight}{$cover-image$}
  \end{center}
  \cleardoublepage
$endif$

$if(title)$
\title{$title$}
$endif$
$if(author)$
\author{$author$}
$endif$
$if(advisor)$
\advisor{$advisor$}
$endif$
$if(coadvisor)$
\coadvisor{$coadvisor$}
$endif$
$if(defenddate)$
\defenddate{$defenddate$}
$endif$
$if(school)$
\school{$school$}
$endif$
$if(institute)$
\institute{$institute$}
$endif$
$if(studentnumber)$
\studentnumber{$studentnumber$}
$endif$
$if(major)$
\major{$major$}
$endif$

$if(englishtitle)$
\englishtitle{$englishtitle$}
$endif$
$if(englishauthor)$
\englishauthor{\textsc{$englishauthor$}}
$endif$
$if(englishadvisor)$
\englishadvisor{Prof. \textsc{$englishadvisor$}}
$endif$
$if(englishcoadvisor)$
\englishcoadvisor{Prof. \textsc{$englishcoadvisor$}}
$endif$
$if(englishschool)$
\englishschool{$englishschool$}
$endif$
$if(englishinstitute)$
\englishinstitute{\textsc{$englishinstitute$} \\
  \textsc{Shanghai Jiao Tong University} \\
  \textsc{Shanghai, P.R.China}}
$endif$
$if(englishmajor)$
\englishmajor{$englishmajor$}
$endif$
$if(englishdate)$
\englishdate{$englishdate$}
$endif$
\maketitle

\makeatletter
\ifsjtu@submit\relax
	\includepdf{handed_pdf/original.pdf}
	\cleardoublepage
	\includepdf{handed_pdf/authorization.pdf}
	\cleardoublepage
\else
\ifsjtu@review\relax
% exclude the original claim and authorization
\else
	\makeDeclareOriginal
	\makeDeclareAuthorization
\fi
\fi
\makeatother

$body$

\backmatter	% 文后无编号部分 

%% 参考资料
\printbibliography[heading=bibintoc]
\end{document}
