\documentclass[$if(fontsize)$$fontsize$,$endif$$if(lang)$$babel-lang$,$endif$$if(papersize)$$papersize$paper,$endif$$for(classoption)$$classoption$$sep$,$endfor$]{$documentclass$}

\usepackage[export]{adjustbox}
\usepackage{etoc}
% 参考 ctexbook.cls 及
% http://www.latextemplates.com/template/the-legrand-orange-book
% https://tex.stackexchange.com/questions/48900/two-independent-tocs
\definecolor{ocre}{RGB}{243,102,25} % Define the orange color used for highlighting throughout the book

% 添加引言块
\def\VA#1#2{\addvspace{12pt}\raggedleft #1\rightskip3em\par #2\rightskip3em}
\renewenvironment{quote}
  {\list{}{\rightmargin\leftmargin}%
    \item\relax}
  {\endlist}

\makeatletter

\newif\ifusepartquote
\usepartquotetrue
\newcommand{\thepartquote}{}
\newcommand{\thepartquoteauthor}{}
\newcommand{\partquote}[2]{\ifusepartquote\renewcommand{\thepartquote}{#1}\renewcommand{\thepartquoteauthor}{#2}\fi}

\newif\ifusepartintro
\usepartintrotrue
\newcommand{\thepartintro}{}
\newcommand{\partintro}[1]{\ifusepartintro\renewcommand{\thepartintro}{#1}\fi}
\newlength\ocreypos
\setlength\ocreypos{.35\paperheight}
% numbered part in the table of contents
\def\@part[#1]#2{%
  \ifnum \c@secnumdepth >-2\relax
    \ifodd \CTEX@part@numbering
      \CTEX@ifnametrue
      \refstepcounter{part}%
    \else
      \CTEX@ifnamefalse
      \CTEX@makeanchor{part*}%
    \fi
  \else
    \CTEX@ifnamefalse
    \CTEX@makeanchor{part*}%
  \fi
  \CTEX@addtocline{part}{#1}%
  \partmark{#1}%
  {\interlinepenalty \@M
   \normalfont \CTEX@part@format
   \ifnum \c@secnumdepth >-2\relax \ifodd \CTEX@part@numbering
     \CTEX@partname \CTEX@part@aftername
   \fi \fi}%
\markboth{}{}%
{\thispagestyle{empty}%
\begin{tikzpicture}[remember picture,overlay]%
\node at (current page.north west){\begin{tikzpicture}[remember picture,overlay]%	
\fill[ocre!20](0cm,0cm) rectangle (\paperwidth,-\paperheight);
\node[anchor=north] at (8cm,-3.75cm){\color{ocre!40}\fontsize{88}{40}\sffamily\bfseries\CTEX@partname};
\node[anchor=south east] at (\paperwidth-2cm,-\ocreypos+0.5cm){\color{ocre!40}\fontsize{44}{20}\sffamily\bfseries\CTEX@part@titleformat{#2}};
\fill[ocre!40](0cm,-\ocreypos) rectangle (\paperwidth,-\ocreypos-0.1cm);
\node[anchor=north west] at (2cm,-\ocreypos-0.5cm){\ifusepartquote\parbox[t][][t]{\paperwidth-4cm}{\begin{quote}
\quad\quad`` \thepartquote ''

\VA{------ \thepartquoteauthor}{}
\end{quote}}\fi};
\node[anchor=south west] at (2cm,-\paperheight+2cm){\ifusepartintro\parbox[t][][t]{\paperwidth/2-2.5cm}{\quad\quad\thepartintro}\fi};
\node[anchor=south east] at (\paperwidth-2cm,-\paperheight+2cm){\parbox[t][][t]{\paperwidth/2-2.5cm}{
\etocsettocstyle{\renewcommand\contentsname{\null}}{}
\etocsetnexttocdepth{0} % 目录层次到章
\localtableofcontents
}};
\end{tikzpicture}};
\end{tikzpicture}}%
\@endpart}
\makeatother

% 加入封面
$if(cover-image)$
\usepackage{wallpaper}
$endif$

\usepackage{booktabs}
\usepackage{longtable}
\usepackage{framed,color}
\definecolor{shadecolor}{RGB}{248,248,248}

\makeatletter
\newenvironment{kframe}{%
\medskip{}
\setlength{\fboxsep}{.8em}
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother
\newenvironment{Shaded}{\begin{kframe}}{\end{kframe}}

\makeatletter
\@ifundefined{Shaded}{
}{\renewenvironment{Shaded}{\begin{kframe}}{\end{kframe}}}
\makeatother
$for(bibliography)$
\addbibresource{$bibliography$}
$endfor$

\providecommand{\tightlist}{%
    \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

$if(href2footnote)$% 是否把链接改为脚注
\let\oldhref\href
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}
$endif$

\usepackage{listings}
% https://github.com/jgm/pandoc/issues/4716
% lstinline 对数学模式存在 bug，等修复后可以改为如下方式
% \newcommand{\passthrough}[1]{#1}
\newcommand{\passthrough}[1]{\lstset{mathescape=false}#1\lstset{mathescape=true}} 


% 感谢 AlexaraWu 的指导 https://github.com/sjtug/SJTUThesis/issues/343
% 兼容 Bookdown 定理等框架
% 重新定义定理环境
\usepackage{amsthm}
\makeatletter
\theoremstyle{plain}
  \newtheorem{theorem}{\sjtu@label@thm~}[chapter]
  \newtheorem{lemma}[theorem]{\sjtu@label@lem~}
  \newtheorem{proposition}[theorem]{\sjtu@label@prop~}
  \newtheorem{corollary}[theorem]{\sjtu@label@cor~}
\theoremstyle{definition}
  \newtheorem{definition}{\sjtu@label@defn~}[chapter]
  \newtheorem{exercise}{练习}[chapter]
  \newtheorem{conjecture}{\sjtu@label@conj~}[chapter]
  \newtheorem{example}{\sjtu@label@exmp~}[chapter]
\theoremstyle{remark}
  \newtheorem{remark}{\sjtu@label@rem~}
  \newtheorem*{solution}{\bfseries{解答}}
\makeatother

\makeatletter
% Boxed/framed environments
\newtheoremstyle{ocrenumbox}% % Theorem style name
{0pt}% Space above
{0pt}% Space below
{\normalfont}% % Body font
{}% Indent amount
{\small\bf\sffamily\color{ocre}}% % Theorem head font
{\;}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily\color{ocre}\thmname{#1}\nobreakspace\thmnumber{\@ifnotempty{#1}{}\@upn{#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries\color{black}---\nobreakspace#3.}} % Optional theorem note


% Defines the theorem text style for each type of theorem to one of the three styles above
\theoremstyle{ocrenumbox}
  \newtheorem{questionT}{}[chapter]
\theoremstyle{plain}
  \newtheorem*{answerT}{答}
\makeatother

%----------------------------------------------------------------------------------------
%	DEFINITION OF COLORED BOXES
%----------------------------------------------------------------------------------------

\RequirePackage[framemethod=default]{mdframed} % Required for creating the theorem, definition, exercise and corollary boxes

% Exercise box	  
\newmdenv[skipabove=7pt,
skipbelow=7pt,
rightline=false,
leftline=true,
topline=false,
bottomline=false,
backgroundcolor=ocre!10,
linecolor=ocre,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=5pt,
innerbottommargin=5pt,
leftmargin=0cm,
rightmargin=0cm,
linewidth=4pt]{qBox}	

% Creates an environment for each type of theorem and assigns it a theorem text style from the "Theorem Styles" section above and a colored box from above

\newenvironment{question}{\begin{qBox}\begin{questionT}}{\end{questionT}\end{qBox}}	
\newenvironment{answer}{\begin{answerT}}{\hfill{\color{ocre}\ensuremath{\blacksquare}}\end{answerT}}%


% https://tex.stackexchange.com/questions/154570/itemize-environment-within-a-tabular-environment/154577
% 添加各类消息框
\newenvironment{rmdblock}[1]
  {
  \begin{table}[!htpb]
  \begin{tabular}{|cc|}
  \hline \quad \quad \quad &
  \begin{minipage}{.88\textwidth}
  \begin{itemize}
  \renewcommand{\labelitemi}{
    \raisebox{-.7\height}[0pt][0pt]{
      {\setkeys{Gin}{width=3em,keepaspectratio}\includegraphics{images/bookdown/#1}}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{kframe}
  \item
  }
  {
  \end{kframe}
  \end{itemize}
  \end{minipage}
  \\
  \hline
  \end{tabular}
  \end{table}
  }
\newenvironment{rmdnote}
  {\begin{rmdblock}{note}}
  {\end{rmdblock}}
\newenvironment{rmdcaution}
  {\begin{rmdblock}{caution}}
  {\end{rmdblock}}
\newenvironment{rmdimportant}
  {\begin{rmdblock}{important}}
  {\end{rmdblock}}
\newenvironment{rmdtip}
  {\begin{rmdblock}{tip}}
  {\end{rmdblock}}
\newenvironment{rmdwarning}
  {\begin{rmdblock}{warning}}
  {\end{rmdblock}}

% 增加每章作者
\newcommand\writeby[1]{\rightline{------ #1}}

\makeatletter
% 实现附录按甲乙丙丁排序，但是仅限于十个以内。否则，报错。
% https://tex.stackexchange.com/questions/219711/definition-with-roman-counter-value
\newcommand\tiangani{甲}
\newcommand\tianganii{乙}
\newcommand\tianganiii{丙}
\newcommand\tianganiv{丁}
\newcommand\tianganv{戊}
\newcommand\tianganvi{己}
\newcommand\tianganvii{庚}
\newcommand\tianganviii{辛}
\newcommand\tianganix{壬}
\newcommand\tianganx{癸}
\newcommand*\Tiangan[1]{\csname tiangan\romannumeral\value{#1}\endcsname}
% https://latex.org/forum/viewtopic.php?t=2674
\let\oldappendix\appendix
\renewcommand\appendix{%
  \oldappendix
  \renewcommand{\CTEX@prechapter}{附录}
  \renewcommand{\CTEX@thechapter}{\Tiangan{chapter}}
  \renewcommand{\thechapter}{\Tiangan{chapter}}
}
\makeatother

% 增加索引功能
%\usepackage{zh­makein­dex}
%\zh­makein­dex


\begin{document}

$if(cover-image)$
  \cleardoublepage
  \thispagestyle{empty}
  \pdfbookmark[0]{封~~~~面}{cover-image}
  \begin{center}
    \ThisTileWallPaper{\paperwidth}{\paperheight}{$cover-image$}
  \end{center}
  \cleardoublepage
$endif$


% https://tex.stackexchange.com/questions/30312/shrink-figure-only-when-necessary
% https://stackoverflow.com/questions/1565988/making-a-small-modification-to-a-latex-environment
% https://tex.stackexchange.com/questions/116670/duplicating-environments
% 修复 Markdown 图片格式过大的问题。
% 需要\usepackage[export]{adjustbox}
\let\oldincludegraphics\includegraphics
\renewcommand\includegraphics[2][]{%
\begin{adjustbox}{max size={\textwidth}{\textheight}}
\oldincludegraphics[#1]{#2}
\end{adjustbox}
}

$if(title)$
\title{$title$}
$endif$
$if(englishtitle)$
\englishtitle{$englishtitle$}
$endif$
$if(author)$
\author{$author$}
$endif$
$if(publisher)$
\publisher{$publisher$}
$endif$
$if(date)$
\date{$date$}
$endif$
\maketitle
\makeDeclareAuthorization

$body$

\backmatter	% 文后无编号部分 

% 索引
%\printindex
%% 参考资料
\printbibliography[heading=bibintoc]
\end{document}
